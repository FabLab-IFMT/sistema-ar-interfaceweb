{% extends 'layout.html' %}
{% load static %}

{% block title %}Agenda — FabLab{% endblock %}

{% block head %}
<style>
/* ── Agenda Home ──────────────────────────────────── */

/* Hero */
.ah-hero{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);padding:3rem 0 2.5rem;color:#fff;margin-bottom:2.5rem}
.ah-hero h1{font-weight:700;font-size:1.75rem;margin:0}
.ah-hero p{opacity:.8;margin:.5rem 0 0;max-width:620px}
.ah-hero-actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:1.25rem}
.ah-hero-actions .fl-btn{display:inline-flex;align-items:center;gap:.45rem;padding:.55rem 1.15rem;border-radius:var(--radius-sm);font-weight:600;font-size:.85rem;border:none;cursor:pointer;transition:all var(--transition);text-decoration:none}
.ah-hero-actions .fl-btn-accent{background:var(--accent);color:#fff}
.ah-hero-actions .fl-btn-accent:hover{background:var(--accent-light);transform:translateY(-1px)}
.ah-hero-actions .fl-btn-ghost{background:rgba(255,255,255,.15);color:#fff;backdrop-filter:blur(4px)}
.ah-hero-actions .fl-btn-ghost:hover{background:rgba(255,255,255,.25)}

.ah-layout{display:grid;grid-template-columns:1fr 340px;gap:1.75rem}
@media(max-width:992px){.ah-layout{grid-template-columns:1fr}}

/* Cards genéricos */
.ah-card{background:var(--white);border-radius:var(--radius);box-shadow:0 4px 24px rgba(11,37,69,.07);overflow:hidden;margin-bottom:1.5rem}
.ah-card-head{background:var(--surface-alt);padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ah-card-head h2{font-size:1rem;font-weight:600;margin:0;color:var(--text);display:flex;align-items:center;gap:.5rem}
.ah-card-head h2 i{color:var(--accent);font-size:.95rem}
.ah-card-body{padding:1.5rem}

/* ── Calendário ───────────────────────────────────── */
.ah-cal-nav{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;background:var(--white);border-bottom:1px solid var(--border)}
.ah-cal-nav a{display:inline-flex;align-items:center;gap:.35rem;font-size:.8rem;font-weight:600;color:var(--text-muted);text-decoration:none;padding:.4rem .75rem;border:1px solid var(--border);border-radius:var(--radius-sm);transition:all var(--transition)}
.ah-cal-nav a:hover{border-color:var(--accent);color:var(--accent)}
.ah-cal-nav .ah-month{font-size:1.15rem;font-weight:700;color:var(--text)}

.ah-table{width:100%;border-collapse:separate;border-spacing:2px;table-layout:fixed}
.ah-table th{padding:10px 6px;text-align:center;font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text-muted);background:var(--surface-alt)}
.ah-table td{vertical-align:top;height:110px;padding:6px;border:1px solid var(--border);background:var(--white);transition:background var(--transition)}
.ah-table td:hover{background:var(--surface)}
.ah-table td.ah-empty{background:var(--surface-alt);border-color:transparent}
.ah-table td.ah-today{background:rgba(19,103,138,.04);}
.ah-table td.ah-today .ah-day-num{background:var(--accent);color:#fff}

.ah-day-num{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;font-size:.8rem;font-weight:600;color:var(--text);margin-bottom:4px}

.ah-events{max-height:70px;overflow-y:auto;scrollbar-width:thin}
.ah-ev{display:block;padding:2px 6px;margin-bottom:2px;border-radius:4px;font-size:.7rem;font-weight:500;color:#fff;text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:opacity var(--transition)}
.ah-ev:hover{opacity:.85;color:#fff}
.ah-ev-internal{background:#3B82F6}
.ah-ev-workshop{background:#10B981}
.ah-ev-visit{background:#EF4444}
.ah-ev-maintenance{background:#F59E0B}
.ah-ev-other{background:#8B5CF6}
.ah-ev-google{background:#4285F4}

/* Legenda */
.ah-legend{display:flex;flex-wrap:wrap;gap:1rem;padding:.75rem 0}
.ah-legend-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem;color:var(--text-muted)}
.ah-legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}

/* Próximos eventos */
.ah-upcoming{list-style:none;padding:0;margin:0}
.ah-upcoming li{display:flex;align-items:flex-start;gap:1rem;padding:1rem 0;border-bottom:1px solid var(--border)}
.ah-upcoming li:last-child{border-bottom:none}
.ah-up-date{min-width:50px;text-align:center;flex-shrink:0}
.ah-up-date .ah-up-day{display:block;font-size:1.4rem;font-weight:700;color:var(--text);line-height:1}
.ah-up-date .ah-up-month{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.03em;color:var(--text-muted);margin-top:2px}
.ah-up-info{flex:1;min-width:0}
.ah-up-info h3{font-size:.9rem;font-weight:600;margin:0 0 .25rem;color:var(--text)}
.ah-up-info h3 a{color:inherit;text-decoration:none}
.ah-up-info h3 a:hover{color:var(--accent)}
.ah-up-meta{display:flex;flex-wrap:wrap;gap:.5rem;font-size:.78rem;color:var(--text-muted)}
.ah-up-meta i{margin-right:.2rem}
.ah-up-badge{font-size:.7rem;font-weight:600;padding:.2rem .55rem;border-radius:12px;color:#fff;white-space:nowrap}
.ah-up-badge.bg-internal{background:#3B82F6}
.ah-up-badge.bg-workshop{background:#10B981}
.ah-up-badge.bg-visit{background:#EF4444}
.ah-up-badge.bg-maintenance{background:#F59E0B}
.ah-up-badge.bg-other{background:#8B5CF6}
.ah-up-badge.bg-google{background:#4285F4}

/* ── Sidebar ──────────────────────────────────────── */
.ah-schedule{width:100%;border-collapse:collapse}
.ah-schedule th,.ah-schedule td{padding:.65rem .85rem;text-align:left;border-bottom:1px solid var(--border);font-size:.85rem}
.ah-schedule th{font-weight:600;color:var(--text-muted);text-transform:uppercase;font-size:.75rem;letter-spacing:.03em;background:var(--surface-alt)}
.ah-schedule .ah-closed{color:#EF4444;font-weight:600}

.ah-steps{list-style:none;padding:0;margin:0}
.ah-steps li{display:flex;align-items:flex-start;gap:.75rem;padding:.85rem 0;border-bottom:1px dashed var(--border)}
.ah-steps li:last-child{border-bottom:none}
.ah-step-num{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-light));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0}
.ah-steps h4{font-size:.85rem;font-weight:600;margin:0 0 .15rem;color:var(--text)}
.ah-steps p{font-size:.78rem;color:var(--text-muted);margin:0}

.ah-rules{list-style:none;padding:0;margin:0}
.ah-rules li{position:relative;padding:.5rem 0 .5rem 1.25rem;font-size:.85rem;color:var(--text-muted);border-bottom:1px solid var(--border)}
.ah-rules li:last-child{border-bottom:none}
.ah-rules li::before{content:'';position:absolute;left:0;top:.85rem;width:6px;height:6px;border-radius:50%;background:var(--accent-light)}

/* Admin panel */
.ah-admin-link{display:flex;align-items:center;gap:.75rem;padding:.7rem .85rem;border-radius:var(--radius-sm);background:var(--surface);text-decoration:none;color:var(--text);transition:all var(--transition);margin-bottom:.5rem}
.ah-admin-link:last-child{margin-bottom:0}
.ah-admin-link:hover{background:var(--surface-alt);transform:translateX(3px);color:var(--text)}
.ah-admin-icon{width:34px;height:34px;border-radius:var(--radius-sm);background:var(--white);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.05)}
.ah-admin-icon i{font-size:.9rem;color:var(--accent)}
.ah-admin-link.ah-warn .ah-admin-icon i{color:#F59E0B}
.ah-admin-link.ah-danger .ah-admin-icon i{color:#EF4444}
.ah-admin-text strong{display:block;font-size:.85rem;font-weight:600}
.ah-admin-text span{font-size:.75rem;color:var(--text-muted)}

/* Modal Google Event */
.ah-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;align-items:center;justify-content:center}
.ah-modal-overlay.active{display:flex}
.ah-modal{background:var(--white);border-radius:var(--radius);width:90%;max-width:500px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.ah-modal-head{background:var(--surface-alt);padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.ah-modal-head h3{font-size:1rem;font-weight:600;margin:0;color:var(--text)}
.ah-modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-muted);padding:4px}
.ah-modal-body{padding:1.5rem}
.ah-modal-time{font-size:.85rem;color:var(--text-muted);margin-bottom:.75rem}
.ah-modal-desc{font-size:.9rem;color:var(--text);line-height:1.6;white-space:pre-line}

/* Responsive calendar */
@media(max-width:768px){
  .ah-table th,.ah-table td{height:auto;padding:4px}
  .ah-day-num{width:22px;height:22px;font-size:.7rem}
  .ah-events{max-height:50px}
  .ah-table th{font-size:.65rem}
}
</style>
{% endblock %}

{% block content %}
<!-- Hero -->
<section class="ah-hero">
  <div class="container">
    <h1><i class="fas fa-calendar-alt me-2"></i>Agenda do FabLab</h1>
    <p>Visualize eventos, workshops e horários disponíveis. Agende sua visita ao laboratório.</p>
    <div class="ah-hero-actions">
      {% if user.is_staff %}
        <a href="{% url 'logs:agenda_create_event' %}" class="fl-btn fl-btn-accent"><i class="fas fa-plus-circle"></i> Agendar Evento</a>
        <a href="{% url 'acesso_e_ponto:my_access_history' %}" class="fl-btn fl-btn-ghost"><i class="fas fa-clock"></i> Meus Acessos</a>
      {% endif %}
      <a href="{% url 'logs:request_visit' %}" class="fl-btn fl-btn-ghost"><i class="fas fa-calendar-check"></i> Solicitar Visita</a>
    </div>
  </div>
</section>

<div class="container" style="margin-bottom:3rem">
  <div class="ah-layout">
    <!-- ═══ COLUNA PRINCIPAL ═══ -->
    <div>
      <!-- Calendário -->
      <div class="ah-card">
        <div class="ah-cal-nav">
          <a href="?month={{ prev_month }}&year={{ prev_year }}"><i class="fas fa-chevron-left"></i> Anterior</a>
          <span class="ah-month">{{ month_name }} {{ year }}</span>
          <a href="?month={{ next_month }}&year={{ next_year }}">Próximo <i class="fas fa-chevron-right"></i></a>
        </div>
        <div style="overflow-x:auto">
          <table class="ah-table">
            <thead>
              <tr>
                <th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th>
              </tr>
            </thead>
            <tbody>
              {% for week in calendar %}
              <tr>
                {% for day in week %}
                  {% if day != 0 %}
                    <td class="{% if day == today.day and month == today.month and year == today.year %}ah-today{% endif %}">
                      <span class="ah-day-num">{{ day }}</span>
                      <div class="ah-events">
                        {% for event in events %}
                          {% if event.start_time.day == day and event.start_time.month == month and event.start_time.year == year %}
                            {% if event.is_google %}
                              <span class="ah-ev ah-ev-google js-google-event"
                                    title="{{ event.title }} — {{ event.start_time|date:'H:i' }}"
                                    data-title="{{ event.title|escape }}"
                                    data-description="{{ event.description|default:'Sem descrição'|escape }}"
                                    data-start="{{ event.start_time|date:'d/m/Y H:i' }}"
                                    data-end="{{ event.end_time|date:'d/m/Y H:i' }}"
                                    style="cursor:pointer">
                                <i class="fab fa-google" style="font-size:9px;margin-right:2px"></i>{{ event.title|truncatechars:14 }}
                              </span>
                            {% else %}
                              <a href="{% url 'logs:agenda_event_detail' event.id %}"
                                 class="ah-ev ah-ev-{{ event.event_type }}"
                                 title="{{ event.title }} ({{ event.get_event_type_display }}) — {{ event.start_time|date:'H:i' }}">
                                {{ event.title|truncatechars:14 }}
                              </a>
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      </div>
                    </td>
                  {% else %}
                    <td class="ah-empty"></td>
                  {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Legenda -->
      <div class="ah-card">
        <div class="ah-card-body" style="padding:.85rem 1.5rem">
          <div class="ah-legend">
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#3B82F6"></span> Interno</div>
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#10B981"></span> Workshop</div>
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#EF4444"></span> Visita</div>
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#F59E0B"></span> Manutenção</div>
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#8B5CF6"></span> Outro</div>
            {% if user.is_superuser %}
            <div class="ah-legend-item"><span class="ah-legend-dot" style="background:#4285F4"></span> Google Calendar</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Próximos Eventos -->
      <div class="ah-card">
        <div class="ah-card-head">
          <h2><i class="fas fa-stream"></i> Próximos Eventos</h2>
          <span style="font-size:.8rem;font-weight:600;color:var(--accent)">{{ events|length }} este mês</span>
        </div>
        <div class="ah-card-body">
          {% if events %}
            <ul class="ah-upcoming">
              {% for event in events|slice:":6" %}
              <li>
                <div class="ah-up-date">
                  <span class="ah-up-day">{{ event.start_time|date:"d" }}</span>
                  <span class="ah-up-month">{{ event.start_time|date:"M" }}</span>
                </div>
                <div class="ah-up-info">
                  <h3>
                    {% if event.is_google %}
                      <span class="js-google-event" style="cursor:pointer"
                            data-title="{{ event.title|escape }}"
                            data-description="{{ event.description|default:'Sem descrição'|escape }}"
                            data-start="{{ event.start_time|date:'d/m/Y H:i' }}"
                            data-end="{{ event.end_time|date:'d/m/Y H:i' }}">
                        <i class="fab fa-google me-1" style="font-size:.75rem"></i>{{ event.title }}
                      </span>
                    {% else %}
                      <a href="{% url 'logs:agenda_event_detail' event.id %}">{{ event.title }}</a>
                    {% endif %}
                  </h3>
                  <div class="ah-up-meta">
                    <span><i class="fas fa-clock"></i>{{ event.start_time|date:"H:i" }} — {{ event.end_time|date:"H:i" }}</span>
                    <span class="ah-up-badge bg-{% if event.is_google %}google{% else %}{{ event.event_type }}{% endif %}">{{ event.get_event_type_display }}</span>
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="text-align:center;padding:2rem 0;color:var(--text-muted)">
              <i class="fas fa-calendar-times" style="font-size:2rem;opacity:.3;margin-bottom:.75rem;display:block"></i>
              Nenhum evento agendado para este mês.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ═══ SIDEBAR ═══ -->
    <div>
      <!-- Horários -->
      <div class="ah-card">
        <div class="ah-card-head"><h2><i class="fas fa-clock"></i> Horários</h2></div>
        <div class="ah-card-body" style="padding:0">
          <table class="ah-schedule">
            <thead><tr><th>Dia</th><th>Horário</th></tr></thead>
            <tbody>
              {% for schedule in lab_schedule %}
              <tr>
                <td style="font-weight:500">{{ schedule.get_day_of_week_display }}</td>
                <td>
                  {% if schedule.is_closed %}
                    <span class="ah-closed">Fechado</span>
                  {% else %}
                    {{ schedule.opening_time|time:"H:i" }} — {{ schedule.closing_time|time:"H:i" }}
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="2" style="text-align:center;padding:1rem;color:var(--text-muted)">Não definido</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Como agendar -->
      <div class="ah-card">
        <div class="ah-card-head"><h2><i class="fas fa-info-circle"></i> Como Agendar</h2></div>
        <div class="ah-card-body">
          <ul class="ah-steps">
            <li>
              <span class="ah-step-num">1</span>
              <div><h4>Solicite sua visita</h4><p>Preencha o formulário com seus dados</p></div>
            </li>
            <li>
              <span class="ah-step-num">2</span>
              <div><h4>Aguarde aprovação</h4><p>Análise em até 24 horas</p></div>
            </li>
            <li>
              <span class="ah-step-num">3</span>
              <div><h4>Confirmação</h4><p>Receba um email confirmando a visita</p></div>
            </li>
          </ul>
          <a href="{% url 'logs:request_visit' %}" style="display:block;text-align:center;margin-top:1rem;padding:.6rem;border-radius:var(--radius-sm);background:var(--accent);color:#fff;font-weight:600;font-size:.85rem;text-decoration:none;transition:all var(--transition)"
             onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='var(--accent)'">
            <i class="fas fa-calendar-plus me-1"></i> Solicitar Agora
          </a>
        </div>
      </div>

      <!-- Regras -->
      <div class="ah-card">
        <div class="ah-card-head"><h2><i class="fas fa-list-check"></i> Regras</h2></div>
        <div class="ah-card-body">
          <ul class="ah-rules">
            <li>Sujeito à aprovação prévia</li>
            <li>Mínimo de 48h de antecedência</li>
            <li>Informar número de participantes</li>
            <li>Cancelamentos com antecedência</li>
            <li>Seguir normas de segurança</li>
          </ul>
        </div>
      </div>

      {% if user.is_staff %}
      <!-- Admin Panel -->
      <div class="ah-card">
        <div class="ah-card-head"><h2><i class="fas fa-shield-alt"></i> Administração</h2></div>
        <div class="ah-card-body">
          <a href="{% url 'logs:pending_events' %}" class="ah-admin-link ah-warn">
            <div class="ah-admin-icon"><i class="fas fa-hourglass-half"></i></div>
            <div class="ah-admin-text">
              <strong>Pendentes{% if pending_count %} <span style="background:#EF4444;color:#fff;padding:1px 7px;border-radius:10px;font-size:.7rem;margin-left:4px">{{ pending_count }}</span>{% endif %}</strong>
              <span>Avaliar solicitações</span>
            </div>
          </a>
          <a href="{% url 'acesso_e_ponto:dashboard' %}" class="ah-admin-link">
            <div class="ah-admin-icon"><i class="fas fa-user-clock"></i></div>
            <div class="ah-admin-text"><strong>Controle de Ponto</strong><span>Registros de acesso</span></div>
          </a>
          <a href="{% url 'logs:index' %}" class="ah-admin-link">
            <div class="ah-admin-icon"><i class="fas fa-history"></i></div>
            <div class="ah-admin-text"><strong>Logs do Sistema</strong><span>Histórico de ações</span></div>
          </a>
          <a href="{% url 'admin:logs_event_changelist' %}" class="ah-admin-link">
            <div class="ah-admin-icon"><i class="fas fa-calendar-alt"></i></div>
            <div class="ah-admin-text"><strong>Gerenciar Eventos</strong><span>Editar ou excluir</span></div>
          </a>
          <a href="{% url 'admin:logs_labschedule_changelist' %}" class="ah-admin-link">
            <div class="ah-admin-icon"><i class="fas fa-business-time"></i></div>
            <div class="ah-admin-text"><strong>Gerenciar Horários</strong><span>Funcionamento do lab</span></div>
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal Google Event -->
<div class="ah-modal-overlay" id="googleModal">
  <div class="ah-modal">
    <div class="ah-modal-head">
      <h3 id="gModalTitle"><i class="fab fa-google me-2"></i>Evento do Google</h3>
      <button class="ah-modal-close" id="gModalClose">&times;</button>
    </div>
    <div class="ah-modal-body">
      <div class="ah-modal-time" id="gModalTime"></div>
      <div class="ah-modal-desc" id="gModalDesc"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const overlay = document.getElementById('googleModal');
  const mTitle  = document.getElementById('gModalTitle');
  const mTime   = document.getElementById('gModalTime');
  const mDesc   = document.getElementById('gModalDesc');
  const mClose  = document.getElementById('gModalClose');

  document.querySelectorAll('.js-google-event').forEach(function(el){
    el.addEventListener('click', function(e){
      e.preventDefault();
      const t = this.getAttribute('data-title') || 'Evento do Google';
      const d = this.getAttribute('data-description') || 'Sem descrição';
      const s = this.getAttribute('data-start') || '';
      const en = this.getAttribute('data-end') || '';
      mTitle.innerHTML = '<i class="fab fa-google me-2"></i>' + t;
      mTime.textContent = s && en ? s + ' — ' + en : s;
      mDesc.textContent = d;
      overlay.classList.add('active');
    });
  });

  function closeModal(){ overlay.classList.remove('active'); }
  mClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', function(e){ if(e.target===overlay) closeModal(); });
  document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeModal(); });
});
</script>
{% endblock %}
