{% extends 'layout.html' %}
{% load static %}

{% block title %}Registrar Devolução — Inventário{% endblock %}

{% block content %}
<section style="background:var(--surface-alt);padding:1rem 0;border-bottom:1px solid var(--border)">
  <div class="container">
    <nav class="iv-breadcrumb"><a href="{% url 'inventario:dashboard' %}">Inventário</a> <span class="mx-2">/</span> <a href="{% url 'inventario:emprestimo_list' %}">Empréstimos</a> <span class="mx-2">/</span> <a href="{% url 'inventario:emprestimo_detail' emprestimo.pk %}">Detalhes</a> <span class="mx-2">/</span> <span>Devolução</span></nav>
  </div>
</section>

<section class="fl-section" style="padding:3rem 0 5rem">
  <div class="container" style="max-width:680px">
    <div class="iv-form-card">
      <div class="iv-form-header">
        <div class="iv-form-icon iv-icon-success"><i class="fas fa-undo-alt"></i></div>
        <div><h1>Registrar Devolução</h1><p>Confirme a devolução do item emprestado.</p></div>
      </div>

      <!-- Confirmation Alert -->
      <div class="iv-confirm-alert">
        <i class="fas fa-info-circle iv-confirm-icon"></i>
        <div>
          Você está registrando a devolução de <strong>{{ emprestimo.item.nome }}</strong>
          (código: {{ emprestimo.item.codigo }}) emprestado para <strong>{{ emprestimo.usuario.get_full_name }}</strong>.
        </div>
      </div>

      <!-- Loan Summary -->
      <div class="iv-summary">
        <h3 class="iv-summary-title"><i class="fas fa-clipboard-list me-2"></i>Resumo do empréstimo</h3>
        <div class="iv-summary-grid">
          <div class="iv-summary-row">
            <span class="iv-s-label">Item</span>
            <span class="iv-s-value"><a href="{% url 'inventario:item_detail' emprestimo.item.pk %}" class="iv-link">{{ emprestimo.item.nome }}</a></span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Código</span>
            <span class="iv-s-value" style="font-family:monospace">{{ emprestimo.item.codigo }}</span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Usuário</span>
            <span class="iv-s-value">{{ emprestimo.usuario.get_full_name }}</span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Quantidade</span>
            <span class="iv-s-value">{{ emprestimo.quantidade }} {{ emprestimo.item.get_unidade_display }}</span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Data do empréstimo</span>
            <span class="iv-s-value">{{ emprestimo.data_emprestimo|date:"d/m/Y H:i" }}</span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Previsão de devolução</span>
            <span class="iv-s-value">
              {% if emprestimo.status == 'atrasado' %}
                <span style="color:#dc2626;font-weight:700">{{ emprestimo.data_prevista_devolucao|date:"d/m/Y" }}</span>
                <span class="iv-badge iv-badge-danger iv-badge-pulse" style="margin-left:.25rem;font-size:.62rem">Atrasado</span>
              {% else %}
                {{ emprestimo.data_prevista_devolucao|date:"d/m/Y" }}
                <span class="iv-badge iv-badge-info" style="margin-left:.25rem;font-size:.62rem">No prazo</span>
              {% endif %}
            </span>
          </div>
          <div class="iv-summary-row">
            <span class="iv-s-label">Responsável</span>
            <span class="iv-s-value">{{ emprestimo.responsavel_emprestimo.get_full_name }}</span>
          </div>
        </div>

        {% if emprestimo.observacao %}
        <div class="iv-obs-box">
          <span class="iv-obs-title">Observação do empréstimo:</span>
          <p>{{ emprestimo.observacao }}</p>
        </div>
        {% endif %}
      </div>

      <!-- Form -->
      <form method="post" class="iv-form">
        {% csrf_token %}
        <div class="iv-field-wrap">
          <label class="iv-label" for="{{ form.observacao.id_for_label }}"><i class="fas fa-comment-alt me-1"></i> Observação sobre a devolução</label>
          {{ form.observacao.errors }}
          {{ form.observacao }}
          <span class="iv-hint">Estado de conservação, problemas encontrados, etc.</span>
        </div>

        <!-- Warning -->
        <div class="iv-warning">
          <i class="fas fa-exclamation-triangle iv-warning-icon"></i>
          <div>
            <strong>Ao confirmar a devolução:</strong>
            <ul>
              <li>{{ emprestimo.quantidade }} {{ emprestimo.item.get_unidade_display }} será adicionado de volta ao estoque</li>
              <li>O status será alterado para "Devolvido"</li>
              <li>Você será registrado como responsável pela devolução</li>
            </ul>
          </div>
        </div>

        <div class="iv-form-actions">
          <a href="{% url 'inventario:emprestimo_detail' emprestimo.pk %}" class="iv-btn iv-btn-cancel"><i class="fas fa-times me-1"></i> Cancelar</a>
          <button type="submit" class="iv-btn iv-btn-success"><i class="fas fa-check-circle me-1"></i> Confirmar Devolução</button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('textarea').forEach(function(t){t.classList.add('iv-input');t.rows=3});
});
</script>
{% endblock %}

{% block head %}
<style>
  .iv-breadcrumb{font-size:.85rem}.iv-breadcrumb a{color:var(--accent);text-decoration:none;font-weight:600}.iv-breadcrumb span:last-child{color:var(--text-muted)}
  .iv-form-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
  .iv-form-header{display:flex;align-items:center;gap:1.25rem;padding:2rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(11,37,69,.03),rgba(19,103,138,.04))}
  .iv-form-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;flex-shrink:0}
  .iv-icon-success{background:linear-gradient(135deg,#059669,#10b981)}
  .iv-form-header h1{font-size:1.2rem;font-weight:700;color:var(--primary);margin:0}.iv-form-header p{font-size:.82rem;color:var(--text-muted);margin:.2rem 0 0}

  /* Confirm alert */
  .iv-confirm-alert{display:flex;gap:.75rem;align-items:flex-start;padding:1rem 2rem;background:rgba(19,103,138,.05);border-bottom:1px solid var(--border);font-size:.88rem;color:var(--text)}
  .iv-confirm-icon{color:var(--accent);font-size:1.1rem;margin-top:.15rem}

  /* Summary */
  .iv-summary{padding:1.5rem 2rem;border-bottom:1px solid var(--border)}
  .iv-summary-title{font-size:.88rem;font-weight:700;color:var(--primary);margin:0 0 1rem;display:flex;align-items:center}
  .iv-summary-grid{display:flex;flex-direction:column}
  .iv-summary-row{display:flex;padding:.5rem 0;border-bottom:1px solid var(--border);font-size:.85rem}.iv-summary-row:last-child{border-bottom:none}
  .iv-s-label{width:190px;flex-shrink:0;font-weight:600;color:var(--text-muted)}.iv-s-value{color:var(--text)}
  .iv-link{color:var(--accent);font-weight:600;text-decoration:none}.iv-link:hover{text-decoration:underline}
  .iv-obs-box{margin-top:1rem;padding:.75rem 1rem;background:var(--surface-alt);border-radius:var(--radius-sm);border-left:3px solid var(--accent)}
  .iv-obs-title{font-size:.78rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.4px}
  .iv-obs-box p{font-size:.85rem;color:var(--text);margin:.35rem 0 0;font-style:italic}

  /* Badges */
  .iv-badge{display:inline-flex;align-items:center;padding:.2rem .5rem;border-radius:50px;font-size:.72rem;font-weight:700}
  .iv-badge-danger{background:rgba(239,68,68,.1);color:#dc2626}.iv-badge-info{background:rgba(19,103,138,.1);color:var(--accent)}
  .iv-badge-pulse{animation:ivPulse 2s infinite}@keyframes ivPulse{0%,100%{opacity:1}50%{opacity:.6}}

  /* Form */
  .iv-form{padding:1.5rem 2rem 2rem}
  .iv-field-wrap{margin-bottom:1.25rem}
  .iv-label{display:block;font-size:.82rem;font-weight:600;color:var(--text);margin-bottom:.4rem}
  .iv-input{width:100%;padding:.6rem .85rem;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:.88rem;transition:border-color .25s;font-family:inherit;color:var(--text);background:var(--white)}
  .iv-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(19,103,138,.08)}
  .iv-hint{display:block;font-size:.72rem;color:var(--text-muted);margin-top:.3rem}

  /* Warning */
  .iv-warning{display:flex;gap:.75rem;align-items:flex-start;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:var(--radius-sm);padding:1rem 1.25rem;margin-bottom:1.5rem;font-size:.85rem;color:var(--text)}
  .iv-warning-icon{color:#d97706;margin-top:.15rem;font-size:1rem}
  .iv-warning ul{margin:.4rem 0 0;padding-left:1.2rem}.iv-warning li{margin-bottom:.2rem;font-size:.82rem}

  .iv-form-actions{display:flex;justify-content:flex-end;gap:.75rem;padding-top:1.25rem;border-top:1px solid var(--border)}
  .iv-btn{display:inline-flex;align-items:center;padding:.55rem 1.25rem;border-radius:var(--radius-sm);font-size:.88rem;font-weight:600;text-decoration:none;transition:all var(--transition);cursor:pointer;border:none}
  .iv-btn-cancel{background:transparent;color:var(--text-muted);border:2px solid var(--border)}.iv-btn-cancel:hover{border-color:var(--text-muted);color:var(--text)}
  .iv-btn-success{background:linear-gradient(135deg,#059669,#10b981);color:#fff}.iv-btn-success:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(5,150,105,.2)}

  @media(max-width:600px){.iv-form,.iv-summary,.iv-confirm-alert{padding-left:1.25rem;padding-right:1.25rem}.iv-form-header{padding:1.5rem 1.25rem}.iv-summary-row{flex-direction:column;gap:.15rem}.iv-s-label{width:auto}}
</style>
{% endblock %}