{% extends 'layout.html' %}
{% load static %}

{% block title %}Empréstimo #{{ emprestimo.pk }} — Inventário{% endblock %}

{% block content %}
<section style="background:var(--surface-alt);padding:1rem 0;border-bottom:1px solid var(--border)">
  <div class="container">
    <nav class="iv-breadcrumb"><a href="{% url 'inventario:dashboard' %}">Inventário</a> <span class="mx-2">/</span> <a href="{% url 'inventario:emprestimo_list' %}">Empréstimos</a> <span class="mx-2">/</span> <span>Detalhes #{{ emprestimo.pk }}</span></nav>
  </div>
</section>

<section class="fl-section" style="padding:2.5rem 0 5rem">
  <div class="container">

    <!-- Header -->
    <div class="iv-header">
      <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
        {% if emprestimo.status == 'devolvido' %}
          <span class="iv-badge iv-badge-success"><i class="fas fa-check-circle me-1"></i>Devolvido</span>
        {% elif emprestimo.status == 'atrasado' %}
          <span class="iv-badge iv-badge-danger iv-badge-pulse"><i class="fas fa-exclamation-triangle me-1"></i>Atrasado</span>
        {% else %}
          <span class="iv-badge iv-badge-info"><i class="fas fa-clock me-1"></i>Emprestado</span>
        {% endif %}
        <h1 class="iv-title">{{ emprestimo.item.nome }}</h1>
        <span class="iv-code-tag">{{ emprestimo.item.codigo }}</span>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        {% if emprestimo.status != 'devolvido' %}
        <a href="{% url 'inventario:emprestimo_devolucao' emprestimo.pk %}" class="iv-btn iv-btn-success"><i class="fas fa-undo-alt me-1"></i> Registrar Devolução</a>
        {% endif %}
        <a href="{% url 'inventario:emprestimo_list' %}" class="iv-btn iv-btn-outline"><i class="fas fa-arrow-left me-1"></i> Voltar</a>
      </div>
    </div>

    <div class="iv-detail-layout">
      <!-- Main Info -->
      <div class="iv-main">
        <div class="iv-card">
          <div class="iv-card-head"><i class="fas fa-clipboard-list me-2"></i>Informações do Empréstimo</div>
          <div class="iv-card-body">
            <div class="iv-info-grid">
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-cube me-1"></i>Item</span>
                <span class="iv-info-value"><a href="{% url 'inventario:item_detail' emprestimo.item.pk %}" class="iv-link">{{ emprestimo.item.nome }}</a></span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-barcode me-1"></i>Código</span>
                <span class="iv-info-value">{{ emprestimo.item.codigo }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-user me-1"></i>Usuário</span>
                <span class="iv-info-value">{{ emprestimo.usuario.get_full_name }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-envelope me-1"></i>Email</span>
                <span class="iv-info-value">{{ emprestimo.usuario.email }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-layer-group me-1"></i>Quantidade</span>
                <span class="iv-info-value">{{ emprestimo.quantidade }} {{ emprestimo.item.get_unidade_display }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-calendar-plus me-1"></i>Data do empréstimo</span>
                <span class="iv-info-value">{{ emprestimo.data_emprestimo|date:"d/m/Y H:i" }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-calendar-check me-1"></i>Previsão de devolução</span>
                <span class="iv-info-value">
                  {% if emprestimo.status == 'atrasado' and not emprestimo.data_devolucao %}
                    <span style="color:#dc2626;font-weight:700">{{ emprestimo.data_prevista_devolucao|date:"d/m/Y H:i" }}</span>
                    <span class="iv-badge iv-badge-danger" style="margin-left:.5rem;font-size:.65rem">Atrasado</span>
                  {% else %}
                    {{ emprestimo.data_prevista_devolucao|date:"d/m/Y H:i" }}
                  {% endif %}
                </span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-user-shield me-1"></i>Responsável empréstimo</span>
                <span class="iv-info-value">{{ emprestimo.responsavel_emprestimo.get_full_name }}</span>
              </div>
              {% if emprestimo.data_devolucao %}
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-calendar-minus me-1"></i>Data de devolução</span>
                <span class="iv-info-value" style="color:#059669;font-weight:600">{{ emprestimo.data_devolucao|date:"d/m/Y H:i" }}</span>
              </div>
              <div class="iv-info-row">
                <span class="iv-info-label"><i class="fas fa-user-check me-1"></i>Responsável devolução</span>
                <span class="iv-info-value">{{ emprestimo.responsavel_devolucao.get_full_name }}</span>
              </div>
              {% endif %}
            </div>

            {% if emprestimo.observacao %}
            <div class="iv-obs-box">
              <h4>Observações</h4>
              <p>{{ emprestimo.observacao|linebreaks }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="iv-sidebar">
        <!-- Status Card -->
        <div class="iv-card iv-status-card {% if emprestimo.status == 'devolvido' %}iv-status-ok{% elif emprestimo.status == 'atrasado' %}iv-status-danger{% else %}iv-status-active{% endif %}">
          <div class="iv-card-body" style="text-align:center;padding:1.5rem">
            {% if emprestimo.status == 'devolvido' %}
              <i class="fas fa-check-circle" style="font-size:2.2rem;color:#059669;margin-bottom:.5rem"></i>
              <h4 style="font-size:1rem;font-weight:700;color:#059669;margin-bottom:.35rem">Devolvido</h4>
              <p style="font-size:.8rem;color:var(--text-muted);margin:0">Devolvido em {{ emprestimo.data_devolucao|date:"d/m/Y" }}</p>
            {% elif emprestimo.status == 'atrasado' %}
              <i class="fas fa-exclamation-triangle" style="font-size:2.2rem;color:#dc2626;margin-bottom:.5rem"></i>
              <h4 style="font-size:1rem;font-weight:700;color:#dc2626;margin-bottom:.35rem">Atrasado</h4>
              <p style="font-size:.8rem;color:var(--text-muted);margin:0">Previsto para {{ emprestimo.data_prevista_devolucao|date:"d/m/Y" }}</p>
            {% else %}
              <i class="fas fa-clock" style="font-size:2.2rem;color:var(--accent);margin-bottom:.5rem"></i>
              <h4 style="font-size:1rem;font-weight:700;color:var(--accent);margin-bottom:.35rem">Emprestado</h4>
              <p style="font-size:.8rem;color:var(--text-muted);margin:0">Prazo: {{ emprestimo.data_prevista_devolucao|timeuntil }}</p>
            {% endif %}
          </div>
        </div>

        {% if emprestimo.item.imagem %}
        <!-- Item Image -->
        <div class="iv-card">
          <div class="iv-card-head"><i class="fas fa-image me-2"></i>Foto do Item</div>
          <div class="iv-card-body" style="text-align:center;padding:1rem">
            <img src="{{ emprestimo.item.imagem.url }}" alt="{{ emprestimo.item.nome }}" class="iv-item-img">
          </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="iv-card">
          <div class="iv-card-head"><i class="fas fa-bolt me-2"></i>Ações rápidas</div>
          <div class="iv-card-body" style="padding:1rem">
            <a href="{% url 'inventario:item_detail' emprestimo.item.pk %}" class="iv-sidebar-action"><i class="fas fa-cube me-2"></i>Ver detalhes do item</a>
            <a href="{% url 'inventario:emprestimo_list' %}?status=ativos" class="iv-sidebar-action"><i class="fas fa-clipboard-list me-2"></i>Empréstimos ativos</a>
            {% if emprestimo.status != 'devolvido' %}
            <a href="{% url 'inventario:emprestimo_devolucao' emprestimo.pk %}" class="iv-sidebar-action iv-sidebar-action-success"><i class="fas fa-undo-alt me-2"></i>Registrar devolução</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block head %}
<style>
  .iv-breadcrumb{font-size:.85rem}.iv-breadcrumb a{color:var(--accent);text-decoration:none;font-weight:600}.iv-breadcrumb span:last-child{color:var(--text-muted)}
  .iv-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:2rem}
  .iv-title{font-size:1.45rem;font-weight:800;color:var(--primary);margin:0}
  .iv-code-tag{font-family:monospace;font-size:.78rem;font-weight:600;padding:.2rem .55rem;border-radius:4px;background:var(--surface-alt);color:var(--text-muted);border:1px solid var(--border)}
  .iv-btn{display:inline-flex;align-items:center;padding:.5rem 1.15rem;border-radius:var(--radius-sm);font-size:.85rem;font-weight:600;text-decoration:none;transition:all var(--transition);cursor:pointer;border:none}
  .iv-btn-success{background:linear-gradient(135deg,#059669,#10b981);color:#fff}.iv-btn-success:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(5,150,105,.2);color:#fff}
  .iv-btn-outline{background:transparent;color:var(--text-muted);border:2px solid var(--border)}.iv-btn-outline:hover{border-color:var(--text-muted);color:var(--text)}
  .iv-link{color:var(--accent);font-weight:600;text-decoration:none}.iv-link:hover{text-decoration:underline}

  /* Badges */
  .iv-badge{display:inline-flex;align-items:center;padding:.25rem .65rem;border-radius:50px;font-size:.75rem;font-weight:700}
  .iv-badge-success{background:rgba(16,185,129,.1);color:#059669}.iv-badge-danger{background:rgba(239,68,68,.1);color:#dc2626}.iv-badge-info{background:rgba(19,103,138,.1);color:var(--accent)}
  .iv-badge-pulse{animation:ivPulse 2s infinite}
  @keyframes ivPulse{0%,100%{opacity:1}50%{opacity:.6}}

  /* Layout */
  .iv-detail-layout{display:grid;grid-template-columns:1fr 320px;gap:1.5rem;align-items:start}
  .iv-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1rem}
  .iv-card-head{padding:.85rem 1.25rem;font-size:.82rem;font-weight:700;color:var(--primary);border-bottom:1px solid var(--border);background:var(--surface-alt)}
  .iv-card-body{padding:1.25rem}

  /* Info rows */
  .iv-info-grid{display:flex;flex-direction:column;gap:0}
  .iv-info-row{display:flex;padding:.65rem 0;border-bottom:1px solid var(--border)}.iv-info-row:last-child{border-bottom:none}
  .iv-info-label{width:200px;flex-shrink:0;font-size:.82rem;font-weight:600;color:var(--text-muted)}
  .iv-info-value{font-size:.88rem;color:var(--text)}

  /* Obs */
  .iv-obs-box{margin-top:1rem;padding:1rem;background:var(--surface-alt);border-radius:var(--radius-sm);border-left:3px solid var(--accent)}
  .iv-obs-box h4{font-size:.82rem;font-weight:700;color:var(--primary);margin:0 0 .5rem}.iv-obs-box p{font-size:.85rem;color:var(--text);margin:0}

  /* Status card */
  .iv-status-card{border:none}.iv-status-ok{background:rgba(16,185,129,.05);border:2px solid rgba(16,185,129,.2)}.iv-status-danger{background:rgba(239,68,68,.05);border:2px solid rgba(239,68,68,.2)}.iv-status-active{background:rgba(19,103,138,.05);border:2px solid rgba(19,103,138,.15)}

  /* Sidebar actions */
  .iv-sidebar-action{display:flex;align-items:center;padding:.55rem .75rem;border-radius:var(--radius-sm);color:var(--text);text-decoration:none;font-size:.85rem;font-weight:500;transition:all var(--transition);margin-bottom:.35rem}
  .iv-sidebar-action:hover{background:var(--surface-alt);color:var(--accent)}.iv-sidebar-action i{width:20px;color:var(--text-muted)}
  .iv-sidebar-action-success:hover{background:rgba(16,185,129,.08);color:#059669}.iv-sidebar-action-success:hover i{color:#059669}

  .iv-item-img{max-width:100%;max-height:160px;border-radius:var(--radius-sm);object-fit:cover}

  @media(max-width:900px){.iv-detail-layout{grid-template-columns:1fr}.iv-info-row{flex-direction:column;gap:.2rem}.iv-info-label{width:auto}}
  @media(max-width:600px){.iv-header{flex-direction:column;align-items:flex-start}}
</style>
{% endblock %}