{% extends 'layout.html' %}
{% load static %}

{% block title %}Inventário - FabLab{% endblock %}

{% block head %}
<style>
  /* === HERO SECTION (Blueprint Style) === */
  .equip-hero {
    background-color: #0f172a;
    background-image: 
      linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
    background-size: 40px 40px;
    padding: 80px 0 60px 0;
    margin-bottom: 3rem;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    position: relative;
  }

  .equip-hero::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0; height: 100px;
    background: linear-gradient(to top, #f8f9fa, transparent);
    pointer-events: none;
  }

  /* === CONTROL BAR (Search & Filter) === */
  .control-bar {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    margin-top: -50px; /* Sobe para cima do Hero */
    position: relative;
    z-index: 10;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .search-input-wrapper {
    position: relative;
  }

  .search-input {
    border-radius: 50px;
    padding-left: 45px;
    border: 2px solid #e9ecef;
    height: 50px;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    border-color: var(--primary-blue, #0d6efd);
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
  }

  .search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: #adb5bd;
  }

  /* Filter Pills */
  .filter-pills .btn {
    border-radius: 30px;
    padding: 8px 20px;
    border: 1px solid #e9ecef;
    color: #6c757d;
    font-weight: 500;
    background: white;
    transition: all 0.2s;
  }

  .filter-pills .btn:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
  }

  .filter-pills .btn.active {
    background: var(--primary-blue, #0d6efd);
    color: white;
    border-color: var(--primary-blue, #0d6efd);
    box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
  }

  /* === EQUIPMENT CARDS === */
  .equip-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    height: 100%;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
  }

  .equip-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.08);
    border-color: var(--primary-blue, #0d6efd);
  }

  /* Tech Line no topo */
  .card-tech-line {
    height: 4px;
    background: linear-gradient(90deg, #0d6efd, #0dcaf0);
    width: 100%;
  }

  /* Badge de Status (Estilo LED) */
  .status-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-active .status-dot { background-color: #198754; box-shadow: 0 0 5px #198754; }
  .status-active { color: #198754; border: 1px solid #198754; }

  .status-inactive .status-dot { background-color: #dc3545; }
  .status-inactive { color: #dc3545; border: 1px solid #dc3545; }

  .equip-img-wrapper {
    height: 200px;
    overflow: hidden;
    position: relative;
    background: #f8f9fa;
  }

  .equip-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .equip-card:hover .equip-img {
    transform: scale(1.05);
  }

  .card-body { padding: 20px; }

  .equip-title {
    font-weight: 700;
    font-size: 1.1rem;
    color: #212529;
    margin-bottom: 5px;
  }

  .equip-brand {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    display: block;
    margin-bottom: 15px;
  }

  /* === MODAL STYLES (Datasheet Look) === */
  .modal-tech .modal-content {
    border: none;
    border-radius: 16px;
    overflow: hidden;
  }

  .modal-tech .modal-header {
    background: #212529;
    color: white;
    border-bottom: 1px solid #343a40;
    padding: 20px 30px;
  }

  .modal-tech .modal-body {
    padding: 0;
  }

  .spec-table tr td {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f3f5;
  }

  .spec-label {
    font-weight: 600;
    color: #495057;
    width: 40%;
    background-color: #f8f9fa;
  }

  .spec-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: #212529;
  }

  /* Responsáveis no Modal */
  .resp-chip {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #e9ecef;
    padding: 8px 12px;
    border-radius: 50px;
    margin-bottom: 8px;
    transition: all 0.2s;
  }
  
  .resp-chip:hover {
    border-color: var(--primary-blue, #0d6efd);
    background: #f8f9fa;
  }

  .resp-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
  }

  /* Animations */
  .hidden { display: none !important; }
  .fade-in { animation: fadeIn 0.4s ease forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>
{% endblock %}

{% block content %}

<section class="equip-hero text-center">
  <div class="container">
    <h1 class="display-4 fw-bold mb-2 tracking-tight">Equipamentos</h1>
    <p class="lead text-white-50 mx-auto" style="max-width: 600px; font-weight: 300;">
      Ferramentas de ponta para materializar suas ideias.
    </p>
  </div>
</section>

<div class="container pb-5">
  
  <div class="control-bar mb-5">
    <div class="row align-items-center g-3">
      <div class="col-md-6">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="searchEquipment" class="form-control search-input" placeholder="Buscar por nome, marca ou função...">
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="filter-pills d-flex justify-content-md-end gap-2">
          <button type="button" class="btn active" data-filter="all">Todos</button>
          <button type="button" class="btn" data-filter="ativo"><i class="fas fa-check-circle text-success me-1"></i> Ativos</button>
          <button type="button" class="btn" data-filter="desativado"><i class="fas fa-times-circle text-danger me-1"></i> Inativos</button>
        </div>
      </div>
    </div>
    
    <div class="row mt-3">
      <div class="col-12 text-end">
        <small class="text-muted font-monospace" style="font-size: 0.75rem;">
          SYSTEM_STATUS: <span id="showing-count" class="fw-bold text-dark">{{ materiais|length }}</span> UNIDADES CARREGADAS
        </small>
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-3 g-4" id="equipment-container">
    {% for material in materiais %}
    <div class="col equipment-item fade-in" data-status="{{ material.situacao }}">
      <div class="equip-card h-100 d-flex flex-column">
        <div class="card-tech-line"></div>
        
        {% if material.situacao == 'ativo' %}
          <div class="status-badge status-active">
            <span class="status-dot"></span> OPERACIONAL
          </div>
        {% else %}
          <div class="status-badge status-inactive">
            <span class="status-dot"></span> OFF-LINE
          </div>
        {% endif %}

        <div class="equip-img-wrapper">
          {% if material.imagem_do_material %}
            <img src="{{ material.imagem_do_material.url }}" class="equip-img" alt="{{ material.nome_do_material }}">
          {% else %}
            <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light text-muted">
              <i class="fas fa-cube fa-3x opacity-25"></i>
            </div>
          {% endif %}
        </div>

        <div class="card-body flex-grow-1 d-flex flex-column">
          <span class="equip-brand">
            {% if material.marca %}{{ material.marca }}{% else %}GENÉRICO{% endif %} 
            {% if material.modelo %}| {{ material.modelo }}{% endif %}
          </span>
          <h5 class="equip-title card-title">{{ material.nome_do_material }}</h5>
          
          <p class="card-text text-muted small flex-grow-1">
            {{ material.descricao_do_material|truncatechars:90 }}
          </p>
          
          <button type="button" class="btn btn-outline-primary btn-sm rounded-pill w-100 mt-3 fw-bold" 
                  data-bs-toggle="modal" data-bs-target="#modal{{ material.id }}">
            <i class="fas fa-microchip me-2"></i> VER FICHA TÉCNICA
          </button>
        </div>
      </div>
    </div>

    <div class="modal fade modal-tech" id="modal{{ material.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title font-monospace">
              <i class="fas fa-terminal me-2 text-primary"></i>DATASHEET: {{ material.nome_do_material|upper }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-0">
              <div class="col-md-5 bg-light border-end">
                <div class="p-4">
                  <div class="rounded-3 overflow-hidden shadow-sm mb-4 bg-white border">
                    <img src="{{ material.imagem_do_material.url }}" class="img-fluid" alt="Detail">
                  </div>
                  
                  <h6 class="text-uppercase text-muted small fw-bold mb-3 ls-1">Supervisores Técnicos</h6>
                  {% if material.responsaveis.exists %}
                    {% for responsavel in material.responsaveis.all %}
                      <div class="resp-chip">
                        {% if responsavel.foto %}
                          <img src="{{ responsavel.foto.url }}" class="resp-avatar" alt="Avatar">
                        {% else %}
                           <div class="resp-avatar bg-secondary d-flex align-items-center justify-content-center text-white small">{{ responsavel.nome|slice:":1" }}</div>
                        {% endif %}
                        <div class="lh-1">
                          <div class="fw-bold small">{{ responsavel.nome }}</div>
                          <div class="text-muted" style="font-size: 0.7rem;">{{ responsavel.cargo }}</div>
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted small fst-italic">Equipe Geral FabLab</p>
                  {% endif %}

                  {% if material.link_fabricante %}
                    <a href="{{ material.link_fabricante }}" target="_blank" class="btn btn-dark btn-sm w-100 mt-4 rounded-pill">
                      <i class="fas fa-external-link-alt me-2"></i>Site Fabricante
                    </a>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-7">
                <div class="p-4 h-100 overflow-auto" style="max-height: 80vh;">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="text-primary fw-bold mb-0">ESPECIFICAÇÕES</h6>
                    {% if material.situacao == 'ativo' %}
                      <span class="badge bg-success bg-opacity-10 text-success border border-success">SISTEMA ONLINE</span>
                    {% else %}
                      <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">SISTEMA OFFLINE</span>
                    {% endif %}
                  </div>

                  <table class="table spec-table mb-4">
                    <tbody>
                      {% if material.outras_denominacoes %}
                      <tr><td class="spec-label">Alias</td><td class="spec-value">{{ material.outras_denominacoes }}</td></tr>
                      {% endif %}
                      <tr><td class="spec-label">Fabricante</td><td class="spec-value">{{ material.fabricante|default:"N/A" }}</td></tr>
                      <tr><td class="spec-label">Modelo</td><td class="spec-value">{{ material.modelo|default:"N/A" }}</td></tr>
                      <tr><td class="spec-label">Aquisição</td><td class="spec-value">{{ material.ano_aquisicao|default:"N/D" }}</td></tr>
                    </tbody>
                  </table>

                  {% if material.parametros %}
                  <h6 class="text-primary fw-bold mb-2 mt-4">PARÂMETROS</h6>
                  <div class="bg-light p-3 rounded-3 border font-monospace small text-muted">
                    {{ material.parametros|linebreaks }}
                  </div>
                  {% endif %}

                  <h6 class="text-primary fw-bold mb-2 mt-4">DESCRIÇÃO DETALHADA</h6>
                  <p class="small text-secondary text-justify">
                    {{ material.descricao_do_material }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% empty %}
    <div class="col-12 text-center py-5">
      <div class="p-5 bg-light rounded-3 border border-dashed">
        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Inventário Vazio</h4>
        <p class="text-muted small">Nenhum equipamento cadastrado no sistema.</p>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="no-results" class="row mt-5 hidden">
    <div class="col-12 text-center">
      <div class="py-5">
        <i class="fas fa-search fa-3x text-muted mb-3 opacity-25"></i>
        <h4 class="text-muted">Nenhum item encontrado</h4>
        <p class="text-muted small">Tente ajustar seus filtros de busca.</p>
      </div>
    </div>
  </div>

  <div class="mt-5 pt-5 border-top">
    <h5 class="text-center mb-5 text-uppercase ls-1 text-muted fw-bold">Perguntas Frequentes</h5>
    <div class="row g-4 justify-content-center">
      <div class="col-md-5">
        <div class="d-flex gap-3">
          <div class="flex-shrink-0 text-primary"><i class="fas fa-question-circle fs-4"></i></div>
          <div>
            <h6 class="fw-bold">Preciso de treinamento?</h6>
            <p class="small text-muted">Sim. Equipamentos como a Laser e CNC exigem certificação interna de segurança.</p>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <div class="d-flex gap-3">
          <div class="flex-shrink-0 text-primary"><i class="fas fa-coins fs-4"></i></div>
          <div>
            <h6 class="fw-bold">Qual o custo de uso?</h6>
            <p class="small text-muted">O uso das máquinas é gratuito. O usuário deve apenas trazer seus consumíveis (filamento, madeira, etc).</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchEquipment');
    const filterButtons = document.querySelectorAll('.filter-pills .btn');
    const equipmentItems = document.querySelectorAll('.equipment-item');
    const noResults = document.getElementById('no-results');
    const showingCount = document.getElementById('showing-count');
    
    function filterEquipments() {
      const searchValue = searchInput.value.toLowerCase();
      const activeFilter = document.querySelector('.filter-pills .btn.active').dataset.filter;
      
      let visibleCount = 0;
      
      equipmentItems.forEach(item => {
        const title = item.querySelector('.equip-title').textContent.toLowerCase();
        const brand = item.querySelector('.equip-brand').textContent.toLowerCase();
        const status = item.dataset.status;
        
        const matchesSearch = title.includes(searchValue) || brand.includes(searchValue);
        const matchesFilter = activeFilter === 'all' || activeFilter === status;
        
        if (matchesSearch && matchesFilter) {
          item.classList.remove('hidden');
          // Re-trigger animation
          item.style.animation = 'none';
          item.offsetHeight; /* trigger reflow */
          item.style.animation = 'fadeIn 0.4s ease forwards';
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });
      
      showingCount.textContent = visibleCount;
      
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }
    
    searchInput.addEventListener('input', filterEquipments);
    
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        filterEquipments();
      });
    });
  });
</script>
{% endblock %}