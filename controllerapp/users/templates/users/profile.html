{% extends 'layout.html' %}
{% load static %}

{% block title %}Perfil{% endblock %}

{% block head %}
<style>
  .profile-hero {
    background: linear-gradient(135deg, #0b2545, #134074, #13678a);
    color: #fff;
    padding: 48px 0 36px;
    position: relative;
    overflow: hidden;
  }
  .profile-hero::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 20%, rgba(69,196,176,.15), transparent 35%),
                radial-gradient(circle at 80% 0%, rgba(255,255,255,.08), transparent 30%);
    pointer-events: none;
  }
  .avatar-badge {
    width: 92px;
    height: 92px;
    border-radius: 28px;
    background: rgba(255,255,255,.08);
    display: grid;
    place-items: center;
    font-size: 30px;
    font-weight: 800;
    letter-spacing: .02em;
    border: 1px solid rgba(255,255,255,.16);
    box-shadow: 0 12px 32px rgba(0,0,0,.12);
  }
  .avatar-photo { width:92px; height:92px; border-radius:28px; object-fit:cover; border:2px solid rgba(255,255,255,.35); box-shadow:0 12px 32px rgba(0,0,0,.12); background:#fff; }
  .avatar-wrap { position:relative; width:92px; height:92px; }
  .avatar-edit {
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.35);
    color:#fff;
    border-radius:28px;
    opacity:0;
    transition:opacity .2s ease;
    cursor:pointer;
    font-size:1rem;
  }
  .avatar-wrap:hover .avatar-edit { opacity:1; }
  .avatar-input { display:none; }
  .glass-card {
    background: #fff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 12px 40px rgba(11,37,69,.12);
  }
  .stat-chip {
    background: #f5f7fb;
    border-radius: 12px;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
  }
  .xp-bar {
    height: 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.25);
    overflow: hidden;
  }
  .xp-bar span {
    display: block;
    height: 100%;
    background: linear-gradient(90deg, #45c4b0, #8be9c7);
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .35rem .75rem;
    border-radius: 999px;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.25);
    color: #fff;
    font-weight: 600;
    font-size: .9rem;
  }
  .role-chip {
    display: inline-block;
    background: #eef2ff;
    color: #4338ca;
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 600;
    font-size: .85rem;
    border: 1px solid #e0e7ff;
  }
  .role-chip.role-projetista { background:#ecfdf3; color:#166534; border-color:#bbf7d0; }
  .role-chip.role-pending { background:#fffbeb; color:#92400e; border-color:#fcd34d; }
  .role-chip.role-cta { background:#eef2ff; color:#4338ca; border-color:#c7d2fe; text-decoration:none; }
  .mini-card {
    border-radius: 14px;
    border: 1px solid #edf1f7;
    padding: 18px;
    background: #fff;
    box-shadow: 0 8px 24px rgba(11,37,69,.06);
  }
  .timeline-dot {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #13678a;
    margin-top: 6px;
  }
</style>
{% endblock %}

{% block content %}
<section class="profile-hero">
  <div class="container position-relative" style="z-index:1;">
    <div class="row align-items-center g-4">
      <div class="col-lg-8 d-flex align-items-center gap-4">
        <div class="avatar-wrap">
          {% if profile_user.profile_image and profile_user.profile_image.name %}
            <img src="{{ profile_user.profile_image.url }}" alt="Foto de perfil" class="avatar-photo">
          {% else %}
            <div class="avatar-badge text-uppercase">{{ profile_user.first_name|first }}{{ profile_user.last_name|first }}</div>
          {% endif %}
          {% if is_self %}
          <form method="post" action="" enctype="multipart/form-data" class="avatar-edit" title="Alterar foto">
            {% csrf_token %}
            <label class="w-100 h-100 d-flex align-items-center justify-content-center mb-0" style="cursor:pointer;">
              <i class="fas fa-pen"></i>
              <input class="avatar-input" type="file" name="profile_image" accept="image/*" onchange="this.form.submit();">
            </label>
          </form>
          {% endif %}
        </div>
        <div>
          <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
            <h1 class="h3 mb-0">{{ profile_user.first_name }} {{ profile_user.last_name }}</h1>
            {% if profile_user.is_superuser %}
              <span class="pill"><i class="fas fa-crown"></i> Admin</span>
            {% elif profile_user.is_staff %}
              <span class="pill"><i class="fas fa-shield-alt"></i> Equipe</span>
            {% else %}
              <span class="pill" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.18);color:#dbeafe;"><i class="fas fa-user"></i> Membro</span>
            {% endif %}
            {% if projectist_status == 'aprovado' %}
              <span class="role-chip role-projetista"><i class="fas fa-hammer me-1"></i>Projetista</span>
            {% elif projectist_status == 'pendente' and is_self %}
              <span class="role-chip role-pending"><i class="fas fa-hourglass-half me-1"></i>Projetista pendente</span>
            {% elif projectist_status == 'disponivel' and is_self %}
              <a class="role-chip role-cta" href="{% url 'users:request_projectist' %}"><i class="fas fa-plus me-1"></i>Pedir título</a>
            {% endif %}
            {% for role in profile_user.roles.all %}
              <span class="role-chip"><i class="fas fa-tag me-1"></i>{{ role.name }}</span>
            {% endfor %}
          </div>
          <div class="text-white-75 mb-2">Matrícula {{ profile_user.id }} · {{ profile_user.email }}</div>
          {% if not profile_user.roles.all %}
            <div class="d-flex flex-wrap gap-2 mt-2"><span class="role-chip" style="opacity:.7;">Sem cargos atribuídos</span></div>
          {% endif %}
        </div>
      </div>
      <div class="col-lg-4">
        <div class="glass-card p-3" style="background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.2);">
          {% with p=projetos|length kc=kanban_cards|length ev=eventos|length %}
          <div class="d-flex justify-content-between align-items-center mb-2 text-white-75">
            <span>Horas semanais</span>
            <strong>{{ week_hours|floatformat:1 }}h / {{ required_hours|default:0 }}h</strong>
          </div>
          <div class="xp-bar mb-2"><span style="width: {{ progress_percent|default:0 }}%;"></span></div>
          <div class="d-flex justify-content-between text-white-75 small">
            {% if required_hours %}
              <span>Restam {{ time_remaining|floatformat:1 }}h</span>
              <span>{{ progress_percent|default:0 }}% da meta</span>
            {% else %}
              <span>Meta semanal não definida</span>
            {% endif %}
          </div>
          {% endwith %}
        </div>
      </div>
    </div>
  </div>
</section>

<div class="container py-5">
   <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="mini-card">
        <div class="text-muted small">Projetos</div>
        <div class="d-flex align-items-center gap-2">
          <span class="h4 mb-0">{{ projetos|length|default:0 }}</span>
          <i class="fas fa-diagram-project text-primary"></i>
        </div>
        <small class="text-muted">Ativos e participando</small>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="mini-card">
        <div class="text-muted small">Cards Kanban</div>
        <div class="d-flex align-items-center gap-2">
          <span class="h4 mb-0">{{ kanban_cards|length|default:0 }}</span>
          <i class="fas fa-columns text-info"></i>
        </div>
        <small class="text-muted">Tarefas atribuídas</small>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="mini-card">
        <div class="text-muted small">Eventos</div>
        <div class="d-flex align-items-center gap-2">
          <span class="h4 mb-0">{{ eventos|length|default:0 }}</span>
          <i class="fas fa-calendar-check text-success"></i>
        </div>
        <small class="text-muted">Próximos compromissos</small>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="mini-card">
        <div class="text-muted small">Empréstimos</div>
        <div class="d-flex align-items-center gap-2">
          <span class="h4 mb-0">{{ emprestimos_ativos|length|default:0 }}</span>
          <i class="fas fa-box text-warning"></i>
        </div>
        <small class="text-muted">Materiais em uso</small>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="glass-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-1">Missões recentes</h5>
            <div class="text-muted small">Cards Kanban e projetos onde você está atuando</div>
          </div>
          <a href="{% url 'projetos:lista' %}" class="btn btn-sm btn-outline-primary">Ver projetos</a>
        </div>
        <div class="list-group list-group-flush">
          {% if kanban_cards %}
            {% for card in kanban_cards|slice:':4' %}
            <div class="list-group-item d-flex align-items-start gap-3">
              <div class="timeline-dot"></div>
              <div>
                <div class="fw-semibold">{{ card.titulo|default:"Card" }}</div>
                <div class="text-muted small">{% if card.projeto %}Projeto {{ card.projeto }}{% else %}Kanban{% endif %}</div>
              </div>
              <span class="badge bg-light text-dark ms-auto">Kanban</span>
            </div>
            {% endfor %}
          {% elif projetos %}
            {% for projeto in projetos|slice:':4' %}
            <div class="list-group-item d-flex align-items-start gap-3">
              <div class="timeline-dot"></div>
              <div>
                <div class="fw-semibold">{{ projeto.titulo }}</div>
                <div class="text-muted small">{{ projeto.descricao|default:"Projeto"|truncatewords:12 }}</div>
              </div>
              <span class="badge bg-primary-subtle text-primary ms-auto">Projeto</span>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-muted text-center py-3">Sem missões registradas ainda.</div>
          {% endif %}
        </div>
      </div>

      <div class="glass-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-1">Ponto e horas da semana</h5>
            <div class="text-muted small">Acompanhamento do sistema de ponto</div>
          </div>
          {% if active_session %}
            <span class="badge bg-success">Sessão ativa</span>
          {% else %}
            <span class="badge bg-secondary">Sem sessão</span>
          {% endif %}
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between small text-muted mb-1">
            <span>Acumulado</span>
            <span>{{ week_hours|floatformat:1 }}h / {{ required_hours|default:0 }}h</span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar" role="progressbar" style="width: {{ progress_percent|default:0 }}%;" aria-valuenow="{{ progress_percent|default:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          {% if required_hours %}
          <div class="small text-muted mt-1">Faltam {{ time_remaining|floatformat:1 }}h para a meta semanal.</div>
          {% else %}
          <div class="small text-muted mt-1">Meta semanal não configurada.</div>
          {% endif %}
        </div>
        <div class="list-group list-group-flush">
          {% if sessoes_recentes %}
            {% for s in sessoes_recentes %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">Entrada {{ s.entry_time|date:"d/m H:i" }}</div>
                  {% if s.exit_time %}
                    <small class="text-muted">Saída {{ s.exit_time|date:"d/m H:i" }}</small>
                  {% else %}
                    <small class="text-warning">Sessão em aberto</small>
                  {% endif %}
                </div>
                {% if s.duration %}
                  <span class="badge bg-light text-dark">{{ s.duration }}</span>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">Nenhum registro recente.</div>
          {% endif %}
        </div>
      </div>

      <div class="glass-card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-1">Últimos acessos</h5>
            <div class="text-muted small">Entradas registradas recentemente</div>
          </div>
          {% if is_self %}
          <a href="{% url 'acesso_e_ponto:my_access_history' %}" class="btn btn-sm btn-outline-secondary">Histórico completo</a>
          {% endif %}
        </div>
        <div class="list-group list-group-flush">
          {% if sessoes_recentes %}
            {% for s in sessoes_recentes %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">Entrada em {{ s.entry_time|date:"d/m/Y H:i" }}</div>
                  {% if s.exit_time %}
                    <small class="text-muted">Saída {{ s.exit_time|date:"d/m/Y H:i" }}</small>
                  {% else %}
                    <small class="text-warning">Sessão aberta</small>
                  {% endif %}
                </div>
                <span class="badge bg-light text-dark">{{ s.localizacao|default:"FabLab" }}</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted text-center py-3">Nenhuma sessão registrada.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="glass-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Próximos eventos</h5>
          <span class="badge bg-primary-subtle text-primary">Agenda</span>
        </div>
        {% if eventos %}
          <div class="list-group list-group-flush">
            {% for ev in eventos|slice:':4' %}
              <div class="list-group-item">
                <div class="fw-semibold">{{ ev.title|default:"Evento" }}</div>
                <div class="text-muted small">{{ ev.start_time|date:"d/m/Y H:i" }}</div>
                {% if ev.location %}<small class="text-muted">{{ ev.location }}</small>{% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">Nenhum evento agendado.</div>
        {% endif %}
      </div>

      <div class="glass-card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Inventário em uso</h5>
          <span class="badge bg-warning text-dark">Empréstimos</span>
        </div>
        {% if emprestimos_ativos %}
          <div class="list-group list-group-flush">
            {% for emp in emprestimos_ativos|slice:':5' %}
              <div class="list-group-item">
                <div class="fw-semibold">{{ emp.item }}</div>
                <div class="text-muted small">Retirado em {{ emp.data_emprestimo|date:"d/m/Y" }}</div>
                <small class="text-muted">Responsável: {{ emp.usuario }}</small>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">Nenhum empréstimo ativo.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
