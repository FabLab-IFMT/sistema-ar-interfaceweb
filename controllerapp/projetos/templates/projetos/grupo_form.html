{% extends 'layout.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<style>
  .gf-hero{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:2rem 0 1.5rem;position:relative;overflow:hidden}
  .gf-hero::after{content:'';position:absolute;top:-30%;right:-15%;width:50%;height:160%;background:rgba(255,255,255,.04);border-radius:50%;transform:rotate(15deg)}
  .gf-hero h1{font-size:1.4rem;font-weight:800;margin:0}

  .gf-form{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-top:1.5rem}
  .gf-section{margin-bottom:1.75rem}
  .gf-section-title{font-size:.88rem;font-weight:700;color:var(--primary);margin-bottom:1rem;display:flex;align-items:center;gap:.4rem;padding-bottom:.5rem;border-bottom:1px solid var(--border)}
  .gf-field{margin-bottom:1rem}
  .gf-field label{font-size:.76rem;font-weight:600;color:var(--text);margin-bottom:.25rem;display:block;text-transform:uppercase;letter-spacing:.3px}
  .gf-field input,.gf-field select,.gf-field textarea{width:100%;padding:.5rem .85rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.85rem;font-family:inherit;color:var(--text);background:var(--white);transition:border var(--transition)}
  .gf-field input:focus,.gf-field select:focus,.gf-field textarea:focus{outline:none;border-color:var(--accent)}
  .gf-hint{font-size:.68rem;color:var(--text-muted);margin-top:.2rem}

  .gf-select-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
  .gf-select-actions{display:flex;gap:.4rem}
  .gf-select-btn{padding:.2rem .55rem;border-radius:var(--radius-sm);font-size:.68rem;font-weight:600;border:1.5px solid var(--border);background:var(--white);color:var(--text-muted);cursor:pointer;transition:all var(--transition)}
  .gf-select-btn:hover{border-color:var(--accent);color:var(--accent)}
  .gf-counter{font-size:.72rem;font-weight:600;color:var(--accent);padding:.15rem .5rem;background:rgba(19,103,138,.08);border-radius:50px}

  .gf-btn{display:inline-flex;align-items:center;justify-content:center;padding:.5rem 1.25rem;border-radius:var(--radius-sm);font-size:.85rem;font-weight:600;text-decoration:none;transition:all var(--transition);cursor:pointer;border:none;gap:.4rem}
  .gf-btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
  .gf-btn-primary:hover{color:#fff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(11,37,69,.15)}
  .gf-btn-outline{background:transparent;color:var(--text-muted);border:1.5px solid var(--border)}
  .gf-btn-outline:hover{border-color:var(--accent);color:var(--accent)}
  .gf-actions{display:flex;justify-content:flex-end;gap:.65rem;padding-top:1rem;border-top:1px solid var(--border)}

  /* Select2 overrides */
  .select2-container--default .select2-selection--multiple{border:1.5px solid var(--border)!important;border-radius:var(--radius-sm)!important;padding:.3rem .5rem!important;min-height:42px!important;font-family:inherit!important}
  .select2-container--default .select2-selection--multiple:focus-within{border-color:var(--accent)!important}
  .select2-container--default .select2-selection--multiple .select2-selection__choice{background:rgba(19,103,138,.08)!important;border:1px solid rgba(19,103,138,.15)!important;border-radius:var(--radius-sm)!important;color:var(--accent)!important;font-size:.78rem!important;padding:.15rem .5rem!important;font-weight:600!important}
  .select2-container--default .select2-selection--multiple .select2-selection__choice__remove{color:var(--accent)!important;margin-right:.3rem!important}
  .select2-dropdown{border:1.5px solid var(--border)!important;border-radius:var(--radius-sm)!important;box-shadow:0 4px 16px rgba(11,37,69,.1)!important}
  .select2-results__option--highlighted{background:var(--accent)!important}

  .gf-role-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:.3rem}
</style>
{% endblock %}

{% block content %}
<section class="gf-hero">
  <div class="container" style="position:relative;z-index:1">
    <nav style="font-size:.75rem;margin-bottom:.5rem;opacity:.6">
      <a href="{% url 'projetos:gestao' %}" style="color:#fff;text-decoration:none">Gestão</a> /
      <a href="{% url 'projetos:grupos_lista' %}" style="color:#fff;text-decoration:none">Grupos</a> /
      <span>{{ titulo }}</span>
    </nav>
    <h1><i class="fas fa-{% if acao %}edit{% else %}plus-circle{% endif %} me-2"></i>{{ titulo }}</h1>
  </div>
</section>

<div class="container" style="max-width:800px;padding-bottom:3rem">
  <form method="post" class="gf-form">
    {% csrf_token %}

    <!-- Basic Info -->
    <div class="gf-section">
      <div class="gf-section-title"><i class="fas fa-info-circle"></i> Informações Básicas</div>
      <div class="gf-field">
        <label for="nome">Nome do Grupo *</label>
        <input type="text" name="nome" id="nome" required value="{{ grupo.nome|default:'' }}" placeholder="Ex: Equipe de Desenvolvimento">
      </div>
      <div class="gf-field">
        <label for="descricao">Descrição</label>
        <textarea name="descricao" id="descricao" rows="3" placeholder="Descreva o propósito deste grupo...">{{ grupo.descricao|default:'' }}</textarea>
      </div>
    </div>

    <!-- Members -->
    <div class="gf-section">
      <div class="gf-section-title"><i class="fas fa-users"></i> Membros</div>
      <div class="gf-select-header">
        <div class="gf-select-actions">
          <button type="button" class="gf-select-btn" onclick="filterUsers('all')">Todos</button>
          <button type="button" class="gf-select-btn" onclick="filterUsers('superuser')">Super</button>
          <button type="button" class="gf-select-btn" onclick="filterUsers('staff')">Staff</button>
          <button type="button" class="gf-select-btn" onclick="selectAllMembers()">Selecionar Todos</button>
          <button type="button" class="gf-select-btn" onclick="clearMembers()">Limpar</button>
        </div>
        <span class="gf-counter" id="membrosCounter">0 selecionados</span>
      </div>
      <select name="membros" id="membros" multiple class="gf-select2">
        {% for u in usuarios %}
        <option value="{{ u.id }}"
                data-role="{% if u.is_superuser %}superuser{% elif u.is_staff %}staff{% else %}user{% endif %}"
                {% if u.id in membros_selecionados %}selected{% endif %}>
          {{ u.get_full_name|default:u.username }} — {% if u.is_superuser %}Superusuário{% elif u.is_staff %}Staff{% else %}Usuário{% endif %}
        </option>
        {% endfor %}
      </select>
      <p class="gf-hint">Selecione os usuários que farão parte deste grupo</p>
    </div>

    <!-- Projects -->
    <div class="gf-section">
      <div class="gf-section-title"><i class="fas fa-folder"></i> Projetos</div>
      <div class="gf-select-header">
        <div class="gf-select-actions">
          <button type="button" class="gf-select-btn" onclick="filterProjects('all')">Todos</button>
          {% for code, label in status_opcoes %}
          <button type="button" class="gf-select-btn" onclick="filterProjects('{{ code }}')">{{ label }}</button>
          {% endfor %}
          <button type="button" class="gf-select-btn" onclick="selectAllProjects()">Selecionar Todos</button>
          <button type="button" class="gf-select-btn" onclick="clearProjects()">Limpar</button>
        </div>
        <span class="gf-counter" id="projetosCounter">0 selecionados</span>
      </div>
      <select name="projetos" id="projetos" multiple class="gf-select2">
        {% for p in projetos %}
        <option value="{{ p.id }}"
                data-status="{{ p.status }}"
                {% if p.id in projetos_selecionados %}selected{% endif %}>
          {{ p.titulo }} — {{ p.get_status_display }}
        </option>
        {% endfor %}
      </select>
      <p class="gf-hint">Associe projetos a este grupo</p>
    </div>

    <div class="gf-actions">
      <a href="{% url 'projetos:grupos_lista' %}" class="gf-btn gf-btn-outline"><i class="fas fa-times"></i> Cancelar</a>
      <button type="submit" class="gf-btn gf-btn-primary"><i class="fas fa-save"></i> {% if acao %}Salvar Alterações{% else %}Criar Grupo{% endif %}</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function(){
  function formatUser(state){
    if(!state.id)return state.text;
    var role=$(state.element).data('role');
    var color=role==='superuser'?'#8B5CF6':role==='staff'?'#3B82F6':'#6B7280';
    return $('<span><span class="gf-role-indicator" style="background:'+color+'"></span>'+state.text+'</span>');
  }
  $('#membros').select2({placeholder:'Buscar e selecionar membros...',allowClear:true,templateResult:formatUser,templateSelection:formatUser});
  $('#projetos').select2({placeholder:'Buscar e selecionar projetos...',allowClear:true});

  function updateCounters(){
    var m=$('#membros').val()||[];
    var p=$('#projetos').val()||[];
    $('#membrosCounter').text(m.length+' selecionado'+(m.length!==1?'s':''));
    $('#projetosCounter').text(p.length+' selecionado'+(p.length!==1?'s':''));
  }
  $('#membros,#projetos').on('change',updateCounters);
  updateCounters();
});

function filterUsers(role){
  var sel=document.getElementById('membros');
  for(var i=0;i<sel.options.length;i++){
    var opt=sel.options[i];
    opt.hidden=role!=='all'&&opt.dataset.role!==role;
  }
}
function filterProjects(status){
  var sel=document.getElementById('projetos');
  for(var i=0;i<sel.options.length;i++){
    var opt=sel.options[i];
    opt.hidden=status!=='all'&&opt.dataset.status!==status;
  }
}
function selectAllMembers(){$('#membros option:not([hidden])').prop('selected',true);$('#membros').trigger('change')}
function clearMembers(){$('#membros').val(null).trigger('change')}
function selectAllProjects(){$('#projetos option:not([hidden])').prop('selected',true);$('#projetos').trigger('change')}
function clearProjects(){$('#projetos').val(null).trigger('change')}
</script>
{% endblock %}