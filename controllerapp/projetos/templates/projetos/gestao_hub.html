{% extends 'layout.html' %}
{% load static %}

{% block title %}Gestão de Projetos{% endblock %}

{% block head %}
<style>
/* ── Hub de Gestão de Projetos — Institutional Theme ── */

/* Hero */
.gh-hero{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);padding:2.5rem 0;color:#fff}
.gh-hero h1{font-weight:800;font-size:2rem;margin:0}
.gh-hero p{opacity:.8;margin:.25rem 0 0;font-size:.92rem}

/* Stats strip */
.gh-stats{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:-1.5rem;position:relative;z-index:2}
.gh-stat{flex:1;min-width:130px;background:var(--white);border-radius:var(--radius);padding:.85rem 1rem;text-align:center;border:1px solid var(--border);box-shadow:0 2px 8px rgba(11,37,69,.05);transition:var(--transition)}
.gh-stat:hover{box-shadow:0 6px 18px rgba(11,37,69,.1);transform:translateY(-2px)}
.gh-stat-value{font-size:1.5rem;font-weight:800;line-height:1}
.gh-stat-label{font-size:.72rem;color:var(--text-muted);font-weight:500;margin-top:.15rem}

/* Section headers */
.gh-section{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;margin:2rem 0 1rem}
.gh-section h2{font-weight:700;font-size:1.15rem;color:var(--text);margin:0;display:flex;align-items:center;gap:.5rem}
.gh-section h2 i{color:var(--accent)}

/* Filter bar */
.gh-filters{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:1.25rem}
.gh-filters .btn{border-radius:50px;font-size:.82rem;padding:.35rem .85rem;font-weight:500;border-color:var(--border);color:var(--text)}
.gh-filters .btn:hover,.gh-filters .btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.gh-filters .form-control{border-radius:50px;font-size:.85rem;max-width:240px;border:1px solid var(--border)}
.gh-filters .form-control:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(19,103,138,.15)}

/* Project cards */
.gh-project{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;transition:var(--transition);height:100%;display:flex;flex-direction:column;text-decoration:none;color:inherit}
.gh-project:hover{box-shadow:0 8px 28px rgba(11,37,69,.1);transform:translateY(-3px);color:inherit;text-decoration:none}
.gh-project-img{height:140px;background:linear-gradient(135deg,var(--primary),var(--primary-light));display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.gh-project-img img{width:100%;height:100%;object-fit:cover}
.gh-project-img .gh-proj-placeholder{font-size:2.5rem;color:rgba(255,255,255,.4)}
.gh-project-status{position:absolute;top:.65rem;right:.65rem;padding:.2rem .65rem;border-radius:50px;font-size:.7rem;font-weight:600;backdrop-filter:blur(4px)}
.gh-status-em_andamento{background:rgba(234,179,8,.85);color:#fff}
.gh-status-concluido{background:rgba(22,163,74,.85);color:#fff}
.gh-status-planejado{background:rgba(96,165,250,.85);color:#fff}
.gh-status-cancelado{background:rgba(220,38,38,.85);color:#fff}
.gh-project-body{padding:1rem 1.15rem;flex:1;display:flex;flex-direction:column}
.gh-project-title{font-weight:700;font-size:1rem;color:var(--text);margin-bottom:.35rem;line-height:1.3}
.gh-project-desc{font-size:.82rem;color:var(--text-muted);line-height:1.45;margin-bottom:.75rem;flex:1;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.gh-project-footer{display:flex;align-items:center;justify-content:space-between;padding-top:.6rem;border-top:1px solid var(--surface-alt)}
.gh-project-meta{display:flex;gap:.5rem;font-size:.75rem;color:var(--text-muted);font-weight:500}
.gh-project-meta span{display:flex;align-items:center;gap:.25rem}
.gh-project-arrow{color:var(--accent);font-size:.9rem;transition:var(--transition)}
.gh-project:hover .gh-project-arrow{transform:translateX(3px)}

/* Group cards */
.gh-group{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);padding:1.15rem;transition:var(--transition);height:100%}
.gh-group:hover{box-shadow:0 6px 20px rgba(11,37,69,.1);transform:translateY(-2px)}
.gh-group-icon{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-light));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;margin-bottom:.75rem}
.gh-group-title{font-weight:700;font-size:.95rem;color:var(--text);margin-bottom:.35rem}
.gh-group-desc{font-size:.8rem;color:var(--text-muted);margin-bottom:.65rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.gh-group-avatars{display:flex;gap:-.15rem;margin-bottom:.5rem}
.gh-group-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:600;border:2px solid var(--white);margin-left:-4px}
.gh-group-avatar:first-child{margin-left:0}
.gh-group-stats{display:flex;gap:.75rem;font-size:.75rem;color:var(--text-muted)}
.gh-group-stats span{display:flex;align-items:center;gap:.25rem}

/* Empty state */
.gh-empty{text-align:center;padding:3rem 1rem}
.gh-empty i{font-size:3rem;color:var(--border);margin-bottom:.75rem;display:block}
.gh-empty p{color:var(--text-muted);font-weight:500;margin-bottom:1rem}

/* Pagination */
.gh-pagination .page-link{border-radius:var(--radius-sm);margin:0 2px;border:1px solid var(--border);color:var(--text);font-size:.85rem;font-weight:500}
.gh-pagination .page-link:hover{background:var(--surface-alt);border-color:var(--accent);color:var(--accent)}
.gh-pagination .page-item.active .page-link{background:var(--accent);border-color:var(--accent);color:#fff}

@media(max-width:768px){
  .gh-hero h1{font-size:1.5rem}
  .gh-stats{flex-direction:column}
}
</style>
{% endblock %}

{% block content %}
<!-- Hero -->
<section class="gh-hero">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h1><i class="fas fa-project-diagram me-2"></i>Gestão de Projetos</h1>
        <p class="mb-0">Gerencie seus projetos, tarefas e equipes em um só lugar</p>
      </div>
      <div class="d-flex gap-2">
        {% if user.is_superuser %}
        <a href="{% url 'projetos:novo' %}" class="btn btn-light btn-sm" style="border-radius:50px;font-weight:600;color:var(--primary)">
          <i class="fas fa-plus me-1"></i> Novo Projeto
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Stats -->
<div class="container">
  <div class="gh-stats">
    <div class="gh-stat">
      <div class="gh-stat-value" style="color:var(--primary)">{{ total_projetos }}</div>
      <div class="gh-stat-label">Total de Projetos</div>
    </div>
    <div class="gh-stat">
      <div class="gh-stat-value" style="color:#eab308">{{ projetos_em_andamento }}</div>
      <div class="gh-stat-label">Em Andamento</div>
    </div>
    <div class="gh-stat">
      <div class="gh-stat-value" style="color:#16a34a">{{ projetos_concluidos }}</div>
      <div class="gh-stat-label">Concluídos</div>
    </div>
    <div class="gh-stat">
      <div class="gh-stat-value" style="color:#60a5fa">{{ projetos_planejados }}</div>
      <div class="gh-stat-label">Planejados</div>
    </div>
    <div class="gh-stat">
      <div class="gh-stat-value" style="color:var(--accent)">{{ grupos.count }}</div>
      <div class="gh-stat-label">Grupos</div>
    </div>
  </div>
</div>

<div class="container py-2">

  <!-- ═══════ PROJETOS ═══════ -->
  <div class="gh-section">
    <h2><i class="fas fa-folder-open"></i> Projetos</h2>
    <span style="font-size:.82rem;color:var(--text-muted)">Clique em um projeto para acessar seu painel completo</span>
  </div>

  <!-- Filtros -->
  <form method="get" class="gh-filters">
    <a href="{% url 'projetos:gestao' %}" class="btn btn-sm {% if not filtro_status %}active{% endif %}">Todos</a>
    {% for value, label in status_opcoes %}
    <a href="?status={{ value }}" class="btn btn-sm {% if filtro_status == value %}active{% endif %}">{{ label }}</a>
    {% endfor %}
    <div class="ms-auto d-flex gap-2">
      <input type="text" name="busca" class="form-control form-control-sm" placeholder="Buscar projeto..." value="{{ busca }}">
      <button type="submit" class="btn btn-sm" style="background:var(--accent);color:#fff;border-radius:50px;padding:.35rem .85rem"><i class="fas fa-search"></i></button>
    </div>
  </form>

  <!-- Grid de projetos -->
  <div class="row g-3">
    {% for projeto in projetos %}
    <div class="col-md-4 col-sm-6">
      <a href="{% url 'projetos:projeto_painel' projeto.slug %}" class="gh-project">
        <div class="gh-project-img">
            {% if projeto.imagem and projeto.imagem.name %}
            <img src="{{ projeto.imagem.url }}" alt="{{ projeto.titulo }}">
            {% else %}
            <div class="gh-card-placeholder"><i class="fas fa-image"></i></div>
            {% endif %}
          <span class="gh-project-status gh-status-{{ projeto.status }}">
            {{ projeto.get_status_display }}
          </span>
        </div>
        <div class="gh-project-body">
          <div class="gh-project-title">{{ projeto.titulo }}</div>
          <div class="gh-project-desc">{{ projeto.descricao_curta }}</div>
          <div class="gh-project-footer">
            <div class="gh-project-meta">
              <span><i class="fas fa-columns"></i> {{ projeto.total_cards }} cards</span>
              <span><i class="fas fa-tasks"></i> {{ projeto.total_tarefas }} tarefas</span>
            </div>
            <i class="fas fa-arrow-right gh-project-arrow"></i>
          </div>
        </div>
      </a>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="gh-empty">
        <i class="fas fa-folder-open"></i>
        <p>Nenhum projeto encontrado</p>
        {% if user.is_superuser %}
        <a href="{% url 'projetos:novo' %}" class="btn btn-sm" style="background:var(--accent);color:#fff;border-radius:50px;font-weight:600;padding:.4rem 1.25rem">
          <i class="fas fa-plus me-1"></i> Criar Projeto
        </a>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Paginação -->
  {% if projetos.has_other_pages %}
  <nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination gh-pagination mb-0">
      {% if projetos.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ projetos.previous_page_number }}{% if filtro_status %}&status={{ filtro_status }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}">&laquo;</a></li>
      {% endif %}
      {% for num in projetos.paginator.page_range %}
      <li class="page-item {% if projetos.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}{% if filtro_status %}&status={{ filtro_status }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}">{{ num }}</a>
      </li>
      {% endfor %}
      {% if projetos.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ projetos.next_page_number }}{% if filtro_status %}&status={{ filtro_status }}{% endif %}{% if busca %}&busca={{ busca }}{% endif %}">&raquo;</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  <!-- ═══════ GRUPOS ═══════ -->
  <div class="gh-section">
    <h2><i class="fas fa-layer-group"></i> Grupos de Projeto</h2>
    {% if user.is_superuser %}
    <div class="d-flex gap-2">
      <a href="{% url 'projetos:grupos_lista' %}" class="btn btn-sm" style="border:1px solid var(--border);border-radius:50px;font-size:.82rem;color:var(--text-muted);font-weight:500">
        <i class="fas fa-list me-1"></i> Ver Todos
      </a>
      <a href="{% url 'projetos:grupo_novo' %}" class="btn btn-sm" style="background:var(--accent);color:#fff;border-radius:50px;font-size:.82rem;font-weight:600">
        <i class="fas fa-plus me-1"></i> Novo Grupo
      </a>
    </div>
    {% endif %}
  </div>

  <div class="row g-3 mb-4">
    {% for grupo in grupos %}
    <div class="col-md-4 col-sm-6">
      <div class="gh-group">
        <div class="gh-group-icon"><i class="fas fa-users"></i></div>
        <div class="gh-group-title">{{ grupo.nome }}</div>
        {% if grupo.descricao %}
        <div class="gh-group-desc">{{ grupo.descricao }}</div>
        {% endif %}
        <div class="gh-group-avatars mb-2">
          {% for m in grupo.membros.all|slice:":6" %}
          <div class="gh-group-avatar"
               style="{% cycle 'background:var(--accent);color:#fff' 'background:var(--primary);color:#fff' 'background:#059669;color:#fff' 'background:#f97316;color:#fff' 'background:#8b5cf6;color:#fff' 'background:#ec4899;color:#fff' %}"
               title="{{ m.first_name }} {{ m.last_name }}">
            {{ m.first_name|first }}{{ m.last_name|first }}
          </div>
          {% endfor %}
          {% if grupo.membros.count > 6 %}
          <div class="gh-group-avatar" style="background:var(--surface-alt);color:var(--text-muted)">+{{ grupo.membros.count|add:"-6" }}</div>
          {% endif %}
        </div>
        <div class="gh-group-stats">
          <span><i class="fas fa-users"></i> {{ grupo.membros.count }} membros</span>
          <span><i class="fas fa-folder"></i> {{ grupo.projetos.count }} projetos</span>
        </div>
        <a href="{% url 'projetos:grupo_detalhe' grupo.id %}" style="display:inline-block;margin-top:.65rem;font-size:.8rem;color:var(--accent);text-decoration:none;font-weight:600">
          Ver detalhes <i class="fas fa-arrow-right ms-1" style="font-size:.7rem"></i>
        </a>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="gh-empty" style="padding:2rem">
        <i class="fas fa-layer-group" style="font-size:2rem"></i>
        <p>Nenhum grupo encontrado</p>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Quick links -->
  <div style="background:var(--surface-alt);border-radius:var(--radius);padding:1.25rem;margin-bottom:2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem">
    <span style="font-size:.88rem;color:var(--text);font-weight:600"><i class="fas fa-compass me-2" style="color:var(--accent)"></i>Acesso rápido</span>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'canva:kanban' %}" style="font-size:.82rem;color:var(--accent);text-decoration:none;font-weight:600;padding:.35rem .85rem;border:1px solid var(--border);border-radius:50px;background:var(--white);transition:var(--transition)">
        <i class="fas fa-columns me-1"></i> Kanban Global
      </a>
      <a href="{% url 'projetos:todo_list' %}" style="font-size:.82rem;color:var(--accent);text-decoration:none;font-weight:600;padding:.35rem .85rem;border:1px solid var(--border);border-radius:50px;background:var(--white);transition:var(--transition)">
        <i class="fas fa-tasks me-1"></i> Todas as Tarefas
      </a>
      {% if user.is_superuser %}
      <a href="{% url 'projetos:grupos_lista' %}" style="font-size:.82rem;color:var(--accent);text-decoration:none;font-weight:600;padding:.35rem .85rem;border:1px solid var(--border);border-radius:50px;background:var(--white);transition:var(--transition)">
        <i class="fas fa-users-cog me-1"></i> Gerenciar Grupos
      </a>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
